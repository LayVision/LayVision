<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LayVision</title>
    <!-- Tailwind CSS for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Add Tailwind Typography plugin for prose styles -->
    <script src="https://cdn.tailwindcss.com?plugins=typography"></script>
    <!-- Google Fonts: Inter -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        /* Use the Inter font family */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #050505; /* Fallback for older browsers */
            background-image: radial-gradient(circle at 1px 1px, #2d2d2d 1px, transparent 0);
            background-size: 2rem 2rem;
        }

        /* Glassmorphism effect for the header */
        .glass-header {
            background: rgba(18, 18, 18, 0.6); /* Semi-transparent background */
            -webkit-backdrop-filter: blur(10px); /* Frosted glass effect for Safari */
            backdrop-filter: blur(10px); /* Frosted glass effect */
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        /* General view transition */
        .view {
            transition: opacity 0.3s ease-in-out, transform 0.3s ease-in-out;
        }

        .hidden {
            display: none;
            opacity: 0;
            transform: translateY(10px);
        }

        /* Post fade-in animation */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .post-article {
            animation: fadeIn 0.5s ease-out forwards;
        }

        /* Custom button style */
        .btn-primary {
            background-image: linear-gradient(to right, #ffffff, #e2e8f0);
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px 0 rgba(255, 255, 255, 0.1);
        }
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px 0 rgba(255, 255, 255, 0.15);
        }
    </style>
</head>
<body class="text-white antialiased">

    <!-- Main centered container -->
    <div class="container mx-auto max-w-3xl p-4 md:p-6">

        <!-- Header Section -->
        <header class="glass-header flex justify-between items-center mb-6 p-4 rounded-xl sticky top-4 z-50">
            <a href="#" id="logo" class="text-2xl font-extrabold hover:opacity-80 transition-opacity">LayVision</a>
            <nav>
                <button id="login-nav-button" class="font-semibold py-2 px-4 rounded-lg hover:bg-gray-700 transition-colors">Login</button>
                <div id="admin-nav-buttons" class="hidden">
                    <button id="new-post-nav-button" class="font-semibold py-2 px-4 rounded-lg hover:bg-gray-700 transition-colors mr-2">New Post</button>
                    <button id="logout-nav-button" class="font-semibold py-2 px-4 rounded-lg hover:bg-gray-700 transition-colors">Logout</button>
                </div>
            </nav>
        </header>

        <!-- **NEW** Category Filter Bar -->
        <div id="category-filter-container" class="mb-8 md:mb-12 flex flex-wrap justify-center gap-2">
            <!-- Category links will be loaded here -->
        </div>

        <!-- Blog List View -->
        <div id="blog-view" class="view">
            <main id="posts-container" class="space-y-12 md:space-y-16">
                <p class="text-center text-gray-400">Loading posts...</p>
            </main>
            <div id="pagination-container" class="flex justify-center items-center space-x-2 mt-12 md:mt-16"></div>
        </div>

        <!-- Single Post View -->
        <div id="single-post-view" class="view hidden">
            <div class="mb-8">
                <button id="back-to-blog-button" class="text-gray-400 hover:text-white transition-colors font-semibold">
                    &larr; Back to all posts
                </button>
            </div>
            <div id="single-post-content-container"></div>
        </div>

        <!-- Login View -->
        <div id="login-view" class="view hidden">
            <div class="bg-[#111111] border border-gray-800 rounded-xl p-8 shadow-2xl shadow-black">
                <h2 class="text-3xl font-bold text-white text-center mb-6">Admin Login</h2>
                <form id="login-form">
                    <div class="mb-4">
                        <label for="email" class="block text-gray-300 mb-2">Email</label>
                        <input type="email" id="email" class="w-full bg-gray-800 border border-gray-700 rounded-lg px-4 py-2" required>
                    </div>
                    <div class="mb-6">
                        <label for="password" class="block text-gray-300 mb-2">Password</label>
                        <input type="password" id="password" class="w-full bg-gray-800 border border-gray-700 rounded-lg px-4 py-2" required>
                    </div>
                    <button type="submit" class="w-full btn-primary text-black font-bold py-3 px-4 rounded-lg">Login</button>
                </form>
                <p id="login-error" class="text-red-500 text-center mt-4"></p>
            </div>
        </div>

        <!-- New Post View -->
        <div id="new-post-view" class="view hidden">
             <div class="bg-[#111111] border border-gray-800 rounded-xl p-8 shadow-2xl shadow-black">
                <h2 class="text-3xl font-bold text-white text-center mb-6">Create New Post</h2>
                <form id="new-post-form">
                    <div class="mb-4">
                        <label for="post-title" class="block text-gray-300 mb-2">Title</label>
                        <input type="text" id="post-title" class="w-full bg-gray-800 border border-gray-700 rounded-lg px-4 py-2 text-white" required>
                    </div>
                    <!-- **NEW** Category Dropdown -->
                    <div class="mb-4">
                        <label for="post-category" class="block text-gray-300 mb-2">Category</label>
                        <select id="post-category" class="w-full bg-gray-800 border border-gray-700 rounded-lg px-4 py-2 text-white" required>
                            <!-- Options will be populated by JS -->
                        </select>
                    </div>
                    <div class="mb-4">
                        <label for="post-content" class="block text-gray-300 mb-2">Content</label>
                        <textarea id="post-content" rows="6" class="w-full bg-gray-800 border border-gray-700 rounded-lg px-4 py-2 text-white" required></textarea>
                    </div>
                    <div class="mb-4">
                        <label for="post-image-file" class="block text-gray-300 mb-2">Image (Optional)</label>
                        <input type="file" id="post-image-file" class="w-full text-white file:mr-4 file:py-2 file:px-4 file:rounded-lg file:border-0 file:text-sm file:font-semibold file:bg-gray-200 file:text-black hover:file:bg-white" accept="image/*">
                    </div>
                     <div class="mb-6">
                        <label for="post-author" class="block text-gray-300 mb-2">Author Name</label>
                        <input type="text" id="post-author" class="w-full bg-gray-800 border border-gray-700 rounded-lg px-4 py-2 text-white" required>
                    </div>
                    <button type="submit" class="w-full btn-primary text-black font-bold py-3 px-4 rounded-lg disabled:opacity-50">Publish Post</button>
                </form>
                 <p id="publish-message" class="text-center mt-4"></p>
            </div>
        </div>
        
        <!-- Edit Post View -->
        <div id="edit-post-view" class="view hidden">
             <div class="bg-[#111111] border border-gray-800 rounded-xl p-8 shadow-2xl shadow-black">
                <h2 class="text-3xl font-bold text-white text-center mb-6">Edit Post</h2>
                <form id="edit-post-form">
                    <input type="hidden" id="edit-post-id">
                    <div class="mb-4">
                        <label for="edit-post-title" class="block text-gray-300 mb-2">Title</label>
                        <input type="text" id="edit-post-title" class="w-full bg-gray-800 border border-gray-700 rounded-lg px-4 py-2 text-white" required>
                    </div>
                    <!-- **NEW** Category Dropdown -->
                     <div class="mb-4">
                        <label for="edit-post-category" class="block text-gray-300 mb-2">Category</label>
                        <select id="edit-post-category" class="w-full bg-gray-800 border border-gray-700 rounded-lg px-4 py-2 text-white" required>
                             <!-- Options will be populated by JS -->
                        </select>
                    </div>
                    <div class="mb-4">
                        <label for="edit-post-content" class="block text-gray-300 mb-2">Content</label>
                        <textarea id="edit-post-content" rows="6" class="w-full bg-gray-800 border border-gray-700 rounded-lg px-4 py-2 text-white" required></textarea>
                    </div>
                    <div class="mb-4">
                        <label for="edit-post-image-file" class="block text-gray-300 mb-2">Upload New Image (Optional)</label>
                        <input type="file" id="edit-post-image-file" class="w-full text-white file:mr-4 file:py-2 file:px-4 file:rounded-lg file:border-0 file:text-sm file:font-semibold file:bg-gray-200 file:text-black hover:file:bg-white" accept="image/*">
                    </div>
                    <div class="mb-4">
                        <label class="flex items-center text-gray-300">
                            <input type="checkbox" id="delete-image-checkbox" class="h-4 w-4 text-red-600 bg-gray-700 border-gray-600 rounded focus:ring-red-500">
                            <span class="ml-2 text-sm">Delete current image</span>
                        </label>
                    </div>
                     <div class="mb-6">
                        <label for="edit-post-author" class="block text-gray-300 mb-2">Author Name</label>
                        <input type="text" id="edit-post-author" class="w-full bg-gray-800 border border-gray-700 rounded-lg px-4 py-2 text-white" required>
                    </div>
                    <div class="flex space-x-4">
                        <button type="submit" class="w-full btn-primary text-black font-bold py-3 px-4 rounded-lg disabled:opacity-50">Save Changes</button>
                        <button type="button" id="delete-post-button" class="w-full bg-red-600 hover:bg-red-700 text-white font-bold py-3 px-4 rounded-lg transition-colors">Delete Post</button>
                    </div>
                </form>
                 <p id="edit-message" class="text-center mt-4"></p>
            </div>
        </div>
    </div>

    <!-- Footer outside the main container -->
    <footer class="text-center my-8 text-gray-500">
        <p>&copy; 2025 LayVision. All Rights Reserved.</p>
    </footer>

    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, onSnapshot, serverTimestamp, query, orderBy, doc, getDoc, updateDoc, deleteDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyAqElJCSBH1n90fIXY5sBHXfMyRP4eosnQ",
            authDomain: "layvision-web.firebaseapp.com",
            projectId: "layvision-web",
            storageBucket: "layvision-web.appspot.com",
            messagingSenderId: "545099266865",
            appId: "1:545099266865:web:c44575b008003c03760e10"
        };

        const imgbbApiKey = "0ccae505d1ad6ab1656e50cb6e6f06cd";
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // **NEW** Define categories
        const categories = ['Tech', 'Design', 'Lifestyle', 'Tutorials', 'News'];
        let currentFilter = 'All'; // To keep track of the current filter

        // DOM Elements
        const logo = document.getElementById('logo');
        const blogView = document.getElementById('blog-view');
        const loginView = document.getElementById('login-view');
        const newPostView = document.getElementById('new-post-view');
        const editPostView = document.getElementById('edit-post-view');
        const singlePostView = document.getElementById('single-post-view');
        const postsContainer = document.getElementById('posts-container');
        const singlePostContentContainer = document.getElementById('single-post-content-container');
        const paginationContainer = document.getElementById('pagination-container');
        const loginNavButton = document.getElementById('login-nav-button');
        const adminNavButtons = document.getElementById('admin-nav-buttons');
        const newPostNavButton = document.getElementById('new-post-nav-button');
        const logoutNavButton = document.getElementById('logout-nav-button');
        const backToBlogButton = document.getElementById('back-to-blog-button');
        const loginForm = document.getElementById('login-form');
        const newPostForm = document.getElementById('new-post-form');
        const editPostForm = document.getElementById('edit-post-form');
        const deletePostButton = document.getElementById('delete-post-button');
        const loginError = document.getElementById('login-error');
        const publishMessage = document.getElementById('publish-message');
        const editMessage = document.getElementById('edit-message');
        const categoryFilterContainer = document.getElementById('category-filter-container');

        // --- AUTHENTICATION ---
        onAuthStateChanged(auth, user => {
            if (user) {
                loginNavButton.classList.add('hidden');
                adminNavButtons.classList.remove('hidden');
            } else {
                loginNavButton.classList.remove('hidden');
                adminNavButtons.classList.add('hidden');
            }
            handleRouting();
        });

        loginForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            // ... (rest of the function is unchanged)
            try {
                await signInWithEmailAndPassword(auth, document.getElementById('email').value, document.getElementById('password').value);
                window.location.hash = '#page=1';
            } catch (error) {
                loginError.textContent = "Failed to login. Please check your credentials.";
            }
        });

        logoutNavButton.addEventListener('click', () => { signOut(auth).then(() => window.location.hash = '#page=1'); });

        // --- FIRESTORE, ROUTING & PAGINATION ---
        let postsCache = []; 
        const postsPerPage = 5;
        
        const postsCollection = collection(db, 'posts');
        const postsQuery = query(postsCollection, orderBy('createdAt', 'desc'));

        async function handleRouting() {
            renderCategoryFilters(); // Always render filters
            const hash = window.location.hash;
            const postMatch = hash.match(/#post\/(.+)/);
            const pageMatch = hash.match(/#page=(\d+)/);

            if (postMatch) {
                categoryFilterContainer.classList.add('hidden'); // Hide filters on single post view
                const postId = postMatch[1];
                await loadAndShowSinglePost(postId);
            } else {
                categoryFilterContainer.classList.remove('hidden'); // Show filters on blog list view
                const currentPage = pageMatch ? parseInt(pageMatch[1]) : 1;
                showView(blogView);
                renderPage(currentPage);
            }
        }
        
        async function loadAndShowSinglePost(postId) {
            // ... (function is unchanged)
        }
        
        function renderPage(page) {
            postsContainer.innerHTML = '';
            
            // **MODIFIED** Filter posts based on currentFilter
            const filteredPosts = currentFilter === 'All' 
                ? postsCache 
                : postsCache.filter(p => p.post.category === currentFilter);

            const start = (page - 1) * postsPerPage;
            const end = start + postsPerPage;
            const paginatedPosts = filteredPosts.slice(start, end);
            
            if(paginatedPosts.length === 0) {
                 postsContainer.innerHTML = `<p class="text-center text-gray-400">No posts found in this category.</p>`;
            } else {
                const currentUser = auth.currentUser;
                paginatedPosts.forEach((postData) => {
                    const postElement = createPostSummaryElement(postData.post, postData.id, currentUser);
                    postsContainer.appendChild(postElement);
                });
            }

            // **MODIFIED** Pass filteredPosts length to pagination
            renderPagination(page, filteredPosts.length);
        }

        function renderPagination(currentPage, totalItems) {
            paginationContainer.innerHTML = '';
            const totalPages = Math.ceil(totalItems / postsPerPage);
            // ... (rest of the function is unchanged)
        }
        
        onSnapshot(postsQuery, (snapshot) => {
            postsCache = snapshot.docs.map(doc => ({ id: doc.id, post: doc.data() }));
            handleRouting(); 
        }, (error) => {
            postsContainer.innerHTML = '<p class="text-center text-red-500">Could not load posts.</p>';
        });

        window.addEventListener('hashchange', handleRouting);

        // --- **NEW** CATEGORY FILTERING ---
        function renderCategoryFilters() {
            categoryFilterContainer.innerHTML = '';
            const allCategories = ['All', ...categories]; // Add 'All' to the list
            allCategories.forEach(category => {
                const button = document.createElement('button');
                button.textContent = category;
                button.dataset.category = category;
                button.className = `px-4 py-2 rounded-lg text-sm font-semibold transition-colors duration-200 `;
                if (category === currentFilter) {
                    button.className += 'bg-white text-black';
                } else {
                    button.className += 'bg-gray-800/50 hover:bg-gray-700/80';
                }
                categoryFilterContainer.appendChild(button);
            });
        }

        categoryFilterContainer.addEventListener('click', (e) => {
            if (e.target.tagName === 'BUTTON') {
                currentFilter = e.target.dataset.category;
                window.location.hash = '#page=1'; // Go to first page of new filter
                renderCategoryFilters(); // Re-render to show active state
                renderPage(1); // Re-render posts immediately
            }
        });

        // --- HELPER FUNCTIONS FOR RENDERING ---
        function autoLink(text) { /* ... (function is unchanged) ... */ }

        function createPostSummaryElement(post, postId, user) {
            const article = document.createElement('article');
            article.className = 'group post-article ...'; // Abridged for clarity
            
            const formattedDate = post.createdAt ? new Date(post.createdAt.seconds * 1000).toLocaleDateString(/*...*/) : 'Just now';
            const editButtonHtml = user ? `<button data-id="${postId}" class="edit-post-button ...">...</button>` : '';
            const summary = post.content.substring(0, 250) + (post.content.length > 250 ? '...' : '');
            
            // **NEW** Category Badge HTML
            const categoryBadgeHtml = post.category ? `<span class="mb-4 inline-block bg-purple-600/20 text-purple-300 text-xs font-semibold px-3 py-1 rounded-full">${post.category}</span>` : '';

            const imageHtml = post.imageUrl ? `<a href="#post/${postId}" ...><img ...></a>` : '';
            const authorIconHtml = `<div class="... flex-shrink-0">LV</div>`;

            article.innerHTML = `
                ${imageHtml}
                <div class="px-1">
                    ${categoryBadgeHtml}
                    <h2 class="text-3xl ..."><a href="#post/${postId}" ...>${post.title}</a></h2>
                    <div class="flex ...">
                        ${authorIconHtml}
                        <span>By <span class="...">${post.author}</span> &middot; ${formattedDate}</span>
                        ${editButtonHtml}
                    </div>
                    <div class="...">${summary.replace(/\n/g, '<br>')}</div>
                    <a href="#post/${postId}" class="...">Read More &rarr;</a>
                </div>
            `;
            return article;
        }

        function createFullPostElement(post, postId, user) {
            const article = document.createElement('article');
            // ...
            const formattedDate = post.createdAt ? new Date(post.createdAt.seconds * 1000).toLocaleDateString(/*...*/) : 'Just now';
            const editButtonHtml = user ? `<button data-id="${postId}" class="edit-post-button ...">...</button>` : '';
            
             // **NEW** Category Badge HTML
            const categoryBadgeHtml = post.category ? `<span class="mb-4 inline-block bg-purple-600/20 text-purple-300 text-xs font-semibold px-3 py-1 rounded-full">${post.category}</span>` : '';

            const imageHtml = post.imageUrl ? `<img ...>` : '';
            const authorIconHtml = `<div class="... flex-shrink-0">LV</div>`;
            
            article.innerHTML = `
                ${imageHtml}
                <div class="px-1">
                    ${categoryBadgeHtml}
                    <h2 class="text-3xl ...">${post.title}</h2>
                    <div class="flex ...">
                        ${authorIconHtml}
                        <span>By <span class="...">${post.author}</span> &middot; ${formattedDate}</span>
                        ${editButtonHtml}
                    </div>
                    <div class="prose ...">${autoLink(post.content).replace(/\n/g, '<br>')}</div>
                </div>
            `;
            return article;
        }
        
        // **NEW** Helper to populate category dropdowns
        function populateCategoryDropdowns(selectElementId, selectedValue = '') {
            const select = document.getElementById(selectElementId);
            select.innerHTML = ''; // Clear existing options
            categories.forEach(category => {
                const option = document.createElement('option');
                option.value = category;
                option.textContent = category;
                if (category === selectedValue) {
                    option.selected = true;
                }
                select.appendChild(option);
            });
        }


        // --- NEW POST ---
        newPostForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            // ... (image upload logic is unchanged)
            try {
                // ...
                await addDoc(postsCollection, {
                    title: document.getElementById('post-title').value,
                    category: document.getElementById('post-category').value, // **MODIFIED**
                    content: document.getElementById('post-content').value,
                    author: document.getElementById('post-author').value,
                    imageUrl: imageUrl,
                    createdAt: serverTimestamp()
                });
                // ... (rest of the function is unchanged)
            } catch (error) {
                // ...
            } 
        });

        // --- EDIT & DELETE POST --- 
        document.body.addEventListener('click', async (e) => {
            const editButton = e.target.closest('.edit-post-button');
            if (editButton) {
                const postId = editButton.dataset.id;
                const postSnap = await getDoc(doc(db, 'posts', postId));
                if (postSnap.exists()) {
                    const post = postSnap.data();
                    document.getElementById('edit-post-id').value = postId;
                    document.getElementById('edit-post-title').value = post.title;
                    document.getElementById('edit-post-content').value = post.content;
                    document.getElementById('edit-post-author').value = post.author;
                    // **MODIFIED** Populate and select category
                    populateCategoryDropdowns('edit-post-category', post.category); 
                    showView(editPostView);
                }
            }
        });

        editPostForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const postId = document.getElementById('edit-post-id').value;
            
            const updatedData = {
                title: document.getElementById('edit-post-title').value,
                category: document.getElementById('edit-post-category').value, // **MODIFIED**
                content: document.getElementById('edit-post-content').value,
                author: document.getElementById('edit-post-author').value,
            };
            // ... (rest of the update logic is unchanged)
            try {
                // ...
                await updateDoc(doc(db, 'posts', postId), updatedData);
                // ...
            } catch (error) {
                // ...
            }
        });

        deletePostButton.addEventListener('click', async () => { /* ... (function is unchanged) ... */ });

        // --- VIEW SWITCHING ---
        const views = [blogView, loginView, newPostView, editPostView, singlePostView];
        function showView(targetView) {
            // ... (function is unchanged)
        }
        
        newPostNavButton.addEventListener('click', () => {
            populateCategoryDropdowns('post-category'); // **MODIFIED**
            showView(newPostView);
        });
        
        // ... (rest of the event listeners are unchanged)
    </script>
</body>
</html>